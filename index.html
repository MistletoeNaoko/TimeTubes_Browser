<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TimeTubes Web Version</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css">

    <script type="text/javascript" src="js/lib/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/lib/three.min.js"></script>
    <script type="text/javascript" src="js/lib/d3.min.js"></script>
    <script type="text/javascript" src="js/lib/OrbitControls.js"></script>
    <script type="text/javascript" src="js/lib/BufferGeometryUtils.js"></script>
</head>
<body onresize="onResize()">
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">TimeTubes browser</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="#">About<span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Data</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="https://example.com" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Visualization</a>
                <div class="dropdown-menu" aria-labelledby="dropdown01">
                    <a class="dropdown-item" href="#">TimeTubes</a>
                    <a class="dropdown-item" href="#">Another action</a>
                    <a class="dropdown-item" href="#">Something else here</a>
                </div>
            </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
    </div>
</nav>

<main role="main" class="container">
    <div class="starter-template">
        <h1>Bootstrap starter template</h1>
        <input type="file" id="fileUpload" onchange="loadFile()"><input id="Button1" type="button" value="Read" onclick="OnButtonClick()"/>
        <div id="WebGL-TimeTubes"></div>
        <p class="lead">Use this document as a way to quickly start any new project.<br> All you get is this text and a mostly barebones HTML document.</p>
    </div>

</main><!-- /.container -->


<script type="text/javascript" src="js/loadFile.js"></script>
<script type="text/javascript" src="js/TimeTubes.js"></script>
<script type="x-shader/x-vertex" id="vertexShaderSimple">
#define MAX_DATASIZE 500

precision mediump float;

varying vec3 vNormal;
varying vec3 vWorldPosition;
varying float vPositionx;
varying vec2 vColor;
varying float vDisFlag;

uniform int size;
uniform vec3 points[MAX_DATASIZE];
uniform vec2 radiuses[MAX_DATASIZE];
uniform vec2 colors[MAX_DATASIZE];

// How to add clipping planes to shader: https://stackoverflow.com/questions/42532545/add-clipping-to-three-shadermaterial
#include <clipping_planes_pars_vertex>

float CatmullRom( float P0_, float P1_, float P2_, float P3_, float T_ )
{
    return ( ( ( -0.5 * P0_ + 1.5 * P1_ - 1.5 * P2_ + 0.5 * P3_ ) * T_
            + P0_ - 2.5 * P1_ + 2.0 * P2_ - 0.5 * P3_ ) * T_
            - 0.5 * P0_ + 0.5 * P2_ ) * T_
            + P1_;
}

vec3 InterpPos(int idx, float del)
{
    // Calculate interpolated values of QI and UI from the z value
    vec3 result;

    result.x = CatmullRom(points[idx].x, points[idx + 1].x, points[idx + 2].x, points[idx + 3].x, del);
    result.y = CatmullRom(points[idx].y, points[idx + 1].y, points[idx + 2].y, points[idx + 3].y, del);
    result.z = CatmullRom(points[idx].z, points[idx + 1].z, points[idx + 2].z, points[idx + 3].z, del);

    return result;
}

vec2 InterpRad(int idx, float del)
{
    vec2 result;

    result.x = CatmullRom(radiuses[idx].x, radiuses[idx + 1].x, radiuses[idx + 2].x, radiuses[idx + 3].x, del);
    result.y = CatmullRom(radiuses[idx].y, radiuses[idx + 1].y, radiuses[idx + 2].y, radiuses[idx + 3].y, del);

    return result;
}

vec2 InterpColor(int idx, float del)
{
    vec2 result;

    result.x = CatmullRom(colors[idx].x, colors[idx + 1].x, colors[idx + 2].x, colors[idx + 3].x, del);
    result.y = CatmullRom(colors[idx].y, colors[idx + 1].y, colors[idx + 2].y, colors[idx + 3].y, del);

    return result;
}

void main()
{
    #include <begin_vertex>
    //vPositionx = sqrt(position.x * position.x + position.y * position.y);
    // Pass information on the pixel to the fragment shader to add shade
    vNormal = normalMatrix * normal;
    vec4 worldPosition = modelMatrix * vec4(position, 1.0);
    vWorldPosition = worldPosition.xyz;

    // Compute interpolated values for the current pixel
    float Tx = floor(position.z);
    int   Ti = int(Tx);
    float Td = position.z - Tx;
    vDisFlag = 1.0;
    if (Ti >= size - 1)
        vDisFlag = 0.0;
    vec3 currentPos = InterpPos(Ti, Td);
    vec2 currentRad = InterpRad(Ti, Td);
    vColor = InterpColor(Ti, Td);

    // Transform the straight tube based on the data
    vec3 P;
    P.x = currentPos.x + currentRad.x * position.x;
    P.x = -1.0 * P.x;
    P.y = currentPos.y + currentRad.y * position.y;
    P.z = currentPos.z;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(P, 1.0);    // Transform: Camera coordinate -> Local coordinate -> transform
    vec4 mvPosition = modelViewMatrix * vec4(P, 1.0);
    #include <clipping_planes_vertex>
}
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
#define MAX_DATASIZE 500
#define TUBE_NUM 32

precision mediump float;

varying vec3 vNormal;
varying vec3 vWorldPosition;
varying float vPositionx;
varying vec2 vColor;
varying float vDisFlag;

uniform vec3 lightPosition;
uniform vec2 colors[MAX_DATASIZE];
uniform vec2 minmaxVJ;
uniform vec2 minmaxFlx;
uniform sampler2D texture;

#include <clipping_planes_pars_fragment>

void main()
{
    #include <clipping_planes_fragment>
    // Discard pixels out of index
    if (vDisFlag < 1.0)
        discard;

    vec3 lightDirection = normalize(lightPosition - vWorldPosition);
    vec2 T;
    T.x = (vColor.x - minmaxVJ.x) / (minmaxVJ.y - minmaxVJ.x);
    T.y = (vColor.y - minmaxFlx.x) / (minmaxFlx.y - minmaxFlx.x);
    T.y = 1.0 - T.y;
    vec4 resultColor = texture2D(texture, T);
    resultColor.a = 1.0;
    float c = max(0.0, dot(vNormal, lightDirection)) * 0.3;
    float opacity = 1.0 / float(TUBE_NUM);//vPositionx;//vWorldPosition.x;//1.0 / float(TUBE_NUM);
    gl_FragColor = vec4(resultColor.r + c, resultColor.g + c, resultColor.b + c, opacity);
}
</script>
</body>
</html>
